<h1>Manage User: <%= user.name %></h1>

<p><strong>Name:</strong> <%= user.name %></p>
<p><strong>Email:</strong> <%= user.email %></p>
<p><strong>Role:</strong> <%= user.role %></p>

<hr>

<h3>Update Options</h3>

<select id="updateOption" class="form-control">
    <option value="">Choose option</option>
    <option value="name">Update Name</option>
    <option value="email">Update Email</option>
    <option value="role">Update Role</option>
    <option value="password">Update Password</option>
</select>

<div id="inputArea" style="margin-top:20px;"></div>

<button id="updateBtn" class="btn btn-primary">Update User</button>

<hr>

<h3>Danger Zone</h3>
<button id="deleteBtn" class="btn btn-danger">Delete User</button>

<div id="notification" style="
    display:none;
    background:#4caf50;
    color:white;
    padding:10px;
    margin-top:20px;
    border-radius:5px;
"></div>

<script>
    const userId = "<%= user._id %>";
    const csrfToken = "<%= csrfToken %>";

    document.getElementById("updateOption").addEventListener("change", function() {
        const field = this.value;
        const area = document.getElementById("inputArea");
        area.innerHTML = "";

        if (!field) {
            return;
        }

        let label = field.charAt(0).toUpperCase() + field.slice(1);
        
        if (field === 'password') {
            area.innerHTML = `
                <label>New Password</label>
                <input id="updatePassword" class="form-control" type="password" placeholder="Enter new password">
                <label>Confirm Password</label>
                <input id="confirmPassword" class="form-control" type="password" placeholder="Confirm new password">
            `;
        } else if (field === 'role') {
            area.innerHTML = `
                <label>New Role</label>
                <select id="updateField" class="form-control">
                    <option value="admin">Admin</option>
                    <option value="doctor">Doctor</option>
                    <option value="nurse">Nurse</option>
                    <option value="patient">Patient</option>
                </select>
            `;
        } else {
            area.innerHTML = `
                <label>New ${label}</label>
                <input id="updateField" class="form-control" placeholder="Enter new ${field}">
            `;
        }
    });


    document.getElementById("updateBtn").addEventListener("click", async () => {
        const field = document.getElementById("updateOption").value;
        
        if (!field) {
            return showNotification("Please select an option", true);
        }

        let url = `/api/admin/users/${userId}/${field}`;
        let body = {};
        let value;

        if (field === 'password') {
            const pass = document.getElementById("updatePassword")?.value;
            const confirmPass = document.getElementById("confirmPassword")?.value;

            if (!pass || !confirmPass) {
                return showNotification("Please enter and confirm the password", true);
            }
            if (pass !== confirmPass) {
                return showNotification("Passwords do not match", true);
            }
            value = pass;
            body.password = value;
        } else {
            value = document.getElementById("updateField")?.value;

            if (!value) {
                return showNotification(`Please enter a value for ${field}`, true);
            }

            // Map field names to API body properties
            body[field] = value;
        }

        const response = await fetch(url, {
            method: "PUT", // Using PUT for specific updates
            credentials: 'include',
            headers: {
                "Content-Type": "application/json",
                "CSRF-Token": csrfToken 
            },
            body: JSON.stringify(body)
        });

        const data = await response.json();

        if (response.ok && data.status === "success") {
            showNotification(`Updated ${field} successfully!`);
            // Optional: Reload to see changes, or update text dynamically
            setTimeout(() => window.location.reload(), 1500); 
        }
        else if (data.status === "already") {
            showNotification("Already updated!", "warning");
        }
        else {
            showNotification(data.message || "Update failed", true);
        }
    });


    document.getElementById("deleteBtn").addEventListener("click", async () => {
        if (!confirm("Are you sure you want to delete this user? This action is permanent.")) return;

        const response = await fetch(`/api/admin/users/${userId}`, {
            method: "DELETE",
            credentials: 'include',
            headers: {
                "CSRF-Token": csrfToken 
            }
        });

        const data = await response.json();

        if (response.ok) {
            alert("User deleted successfully. Redirecting to user list.");
            window.location.href = "/admin/users";
        } else {
            showNotification(data.message || "Deletion failed", true);
        }
    });


    function showNotification(msg, error = false) {
        const box = document.getElementById("notification");
        box.style.display = "block";
        box.style.background = error ? "#e53935" : (error === "warning" ? "#ffc107" : "#4caf50");
        box.innerText = msg;

        setTimeout(() => {
            box.style.display = "none";
        }, 10000);
    }
</script>
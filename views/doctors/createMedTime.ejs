<h1>Prescribe Medication Time</h1>

<form id="prescribeForm">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <input type="hidden" id="assignId" value="<%= assignmentId %>">

    <p>Assignment ID: <strong><%= assignmentId %></strong></p>
    
    <label for="medicationId">Select Medication:</label><br>
    <select id="medicationId" name="medicationId" required>
        <option value="">-- Select Medication --</option>
        <% medications.forEach(med => { %>
            <option value="<%= med._id %>"><%= med.name %></option>
        <% }); %>
    </select><br><br>

    <label>Times (Comma Separated, e.g., 09:00, 14:00, 20:00):
        <input type="text" name="times" required>
    </label><br>

    <button type="submit">Prescribe Time</button>
</form>

<div id="notify" style="
    display:none;
    padding:10px;
    margin-top:10px;
    color:white;
    background:green;
    border-radius:5px;">
</div>

<script>
document.getElementById("prescribeForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const assignId = document.getElementById("assignId").value;
    const csrf = '<%= csrfToken %>';

    const data = {
        // FIX: Use ID from select element
        medicationId: document.getElementById("medicationId").value, 
        // FIX: The times input name was corrected to match the controller expectation
        times: e.target.times.value 
    };
    
    // Check if medication is selected
    if (!data.medicationId) {
        return showMsg("Please select a medication.", true);
    }

    // FIX: Corrected API path to include /doctor
    const res = await fetch(`/api/doctor/medicatimes/${assignId}`, {
        method: "POST",
        credentials: "include",
        headers: {
            "Content-Type": "application/json",
            "CSRF-Token": csrf
        },
        body: JSON.stringify(data)
    });

    const json = await res.json();

    if (res.ok) {
        showMsg("Medication time created!", false);
        setTimeout(() => {
            window.location = "/doctor/assignments";
        }, 2000);
    } else {
        showMsg(json.message || "Error creating medication time", true);
    }
});

function showMsg(msg, error) {
    const box = document.getElementById("notify");
    box.style.display = "block";
    box.style.background = error ? "red" : "green";
    box.innerText = msg;

    setTimeout(() => {
        box.style.display = "none";
    }, 10000);
}
</script>
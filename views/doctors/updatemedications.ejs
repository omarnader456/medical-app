<h1>Update Medication: <%= medication.name %></h1>

<form id="updateMedForm">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">

    <label>Name</label>
    <input type="text" name="name" value="<%= medication.name %>">

    <label>Description</label>
    <textarea name="description"><%= medication.description %></textarea>

    <label>Side Effects (Comma Separated)</label>
    <textarea name="sideEffects"><%= medication.sideEffects.join(', ') %></textarea> 

    <label>Dosage</label>
    <textarea name="dosage"><%= medication.dosage %></textarea>

    <button type="submit">Update Medication</button>
</form>

<div id="notify-box"
      style="
        display:none;
        position:fixed;
        top:20px;
        right:20px;
        z-index:9999;
        padding:15px;
        border-radius:8px;
        color:white;
        font-weight:bold;
        box-shadow:0 3px 10px rgba(0,0,0,0.3);
      ">
</div>

<script>
document.getElementById("updateMedForm").addEventListener("submit", async (e) => {
    e.preventDefault();

    const form = e.target;
    const medId = "<%= medication._id %>";
    const csrf = "<%= csrfToken %>";

    const body = {
        // Only send fields that have a value
        name: form.name.value,
        description: form.description.value,
        sideEffects: form.sideEffects.value,
        dosage: form.dosage.value,
    };

    // FIX: Corrected API path to include /doctor
    const res = await fetch(`/api/doctor/medications/${medId}`, {
        method: "PUT",
        credentials: "include",
        headers: {
            "Content-Type": "application/json",
            "CSRF-Token": csrf
        },
        body: JSON.stringify(body)
    });

    const json = await res.json();

    if (res.ok && json.status === "success") {
        showNotify("Updated successfully!", "success");
        // Update page with new values after success (optional)
    }
    else if (json.status === "already") {
        showNotify("Already updated!", "warning");
    }
    else {
        showNotify(json.message || "Update failed", "error");
    }
});

function showNotify(message, type="success") {
    const box = document.getElementById("notify-box");

    const colors = {
        success: "#28a745",
        error: "#dc3545",
        warning: "#ffc107"
    };

    box.style.background = colors[type] || colors.success;
    box.innerText = message;
    box.style.display = "block";

    setTimeout(() => {
        box.style.display = "none";
    }, 10000);
}
</script>